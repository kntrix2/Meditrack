<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Meditrack</title>
    <link rel="stylesheet" href="../../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="../../images/app-icon.png" type="image/png">
    <script src="../../js/app.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Barra lateral -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="../../images/app-icon.png" alt="MediTrack" width="30" height="30">
                    MediTrack
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="patient_dashboard.html" class="sidebar-nav-item">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="medications.html" class="sidebar-nav-item">
                    <i class="fas fa-pills"></i> Medicamentos
                </a>
                <a href="appointments.html" class="sidebar-nav-item">
                    <i class="fas fa-calendar-check"></i> Citas
                </a>
                <a href="symptom_history.html" class="sidebar-nav-item">
                    <i class="fas fa-heart-pulse"></i> Síntomas
                </a>
                <a href="rewards.html" class="sidebar-nav-item">
                    <i class="fas fa-trophy"></i> Recompensas
                </a>
                <a href="patient_profile.html" class="sidebar-nav-item active">
                    <i class="fas fa-user"></i> Perfil
                </a>
                <a href="#" id="logoutBtn" class="sidebar-nav-item">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </nav>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Encabezado -->
            <header class="header">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="header-title">Mi Perfil</div>
                <div class="header-actions">
                    <button id="editProfileBtn" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            </header>

            <!-- Área de contenido -->
            <div class="content-area">
                <!-- Cabecera de perfil -->
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img src="images/default-avatar.png" alt="Avatar" id="profileAvatar" onerror="this.src='images/default-avatar.png'">
                    </div>
                    <h2 class="profile-name" id="profileName">Nombre del Paciente</h2>
                    <p class="profile-info" id="profileRole">Paciente</p>
                </div>
                
                <div class="dashboard-cards">
                    <!-- Información personal -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-id-card"></i> Información Personal
                        </div>
                        <div class="dashboard-card-content" id="personalInfo">
                            <!-- Se llenará dinámicamente con JavaScript -->
                            <div class="profile-info-item">
                                <div class="profile-info-label">
                                    <i class="fas fa-envelope"></i> Email
                                </div>
                                <div class="profile-info-value" id="profileEmail">
                                    usuario@ejemplo.com
                                </div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">
                                    <i class="fas fa-phone"></i> Teléfono
                                </div>
                                <div class="profile-info-value" id="profilePhone">
                                    +34 123 456 789
                                </div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">
                                    <i class="fas fa-calendar"></i> Fecha de Nacimiento
                                </div>
                                <div class="profile-info-value" id="profileBirthday">
                                    01/01/1980
                                </div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">
                                    <i class="fas fa-venus-mars"></i> Género
                                </div>
                                <div class="profile-info-value" id="profileGender">
                                    No especificado
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información médica -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-notes-medical"></i> Información Médica
                        </div>
                        <div class="dashboard-card-content" id="medicalInfo">
                            <!-- Se llenará dinámicamente con JavaScript -->
                            <div class="profile-info-item">
                                <div class="profile-info-label">
                                    <i class="fas fa-user-md"></i> Médico Principal
                                </div>
                                <div class="profile-info-value" id="profileDoctor">
                                    Dr. Martínez
                                </div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">
                                    <i class="fas fa-hospital"></i> Centro Médico
                                </div>
                                <div class="profile-info-value" id="profileClinic">
                                    Hospital Central
                                </div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">
                                    <i class="fas fa-allergies"></i> Alergias
                                </div>
                                <div class="profile-info-value" id="profileAllergies">
                                    Ninguna conocida
                                </div>
                            </div>
                            <div class="profile-info-item">
                                <div class="profile-info-label">
                                    <i class="fas fa-notes-medical"></i> Condiciones Médicas
                                </div>
                                <div class="profile-info-value" id="profileConditions">
                                    Hipertensión, Diabetes Tipo 2
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contactos de emergencia -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-phone-alt"></i> Contactos de Emergencia
                        </div>
                        <div class="dashboard-card-content" id="emergencyContacts">
                            <!-- Se llenará dinámicamente con JavaScript -->
                            <div class="contact-card">
                                <div class="contact-info">
                                    <div class="contact-name">Ana Gómez</div>
                                    <div class="contact-relation">Familiar - Esposa</div>
                                </div>
                                <div class="contact-details">
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i> +34 612 345 678
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-envelope"></i> ana@email.com
                                    </div>
                                </div>
                            </div>
                            
                            <button id="addEmergencyContact" class="btn btn-outline mt-2">
                                <i class="fas fa-plus"></i> Añadir Contacto
                            </button>
                        </div>
                    </div>
                    
                    <!-- Preferencias de la app -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <i class="fas fa-cog"></i> Preferencias
                        </div>
                        <div class="dashboard-card-content">
                            <div class="preference-item">
                                <div class="preference-label">Notificaciones</div>
                                <label class="toggle">
                                    <input type="checkbox" id="notificationToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="preference-item">
                                <div class="preference-label">Recordatorios por email</div>
                                <label class="toggle">
                                    <input type="checkbox" id="emailToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="preference-item">
                                <div class="preference-label">Compartir datos con médicos</div>
                                <label class="toggle">
                                    <input type="checkbox" id="shareToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="preference-item">
                                <div class="preference-label">Modo oscuro</div>
                                <label class="toggle">
                                    <input type="checkbox" id="darkModeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Barra de navegación inferior para móviles -->
        <nav class="bottom-nav">
            <div class="bottom-nav-items">
                <a href="patient_dashboard.html" class="bottom-nav-item">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="medications.html" class="bottom-nav-item">
                    <i class="fas fa-pills"></i>
                    <span>Medicamentos</span>
                </a>
                <a href="appointments.html" class="bottom-nav-item">
                    <i class="fas fa-calendar-check"></i>
                    <span>Citas</span>
                </a>
                <a href="symptom_history.html" class="bottom-nav-item">
                    <i class="fas fa-heart-pulse"></i>
                    <span>Síntomas</span>
                </a>
                <a href="more.html" class="bottom-nav-item active">
                    <i class="fas fa-ellipsis-h"></i>
                    <span>Más</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Modal de edición de perfil -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Perfil</h2>
                <button class="modal-close" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="form-group">
                        <label for="editName">Nombre completo</label>
                        <input type="text" id="editName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Teléfono</label>
                        <input type="tel" id="editPhone" name="phone">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editBirthday">Fecha de nacimiento</label>
                            <input type="date" id="editBirthday" name="birthday">
                        </div>
                        <div class="form-group">
                            <label for="editGender">Género</label>
                            <select id="editGender" name="gender">
                                <option value="">No especificar</option>
                                <option value="male">Masculino</option>
                                <option value="female">Femenino</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-divider"></div>
                    <h3>Información Médica</h3>
                    <div class="form-group">
                        <label for="editDoctor">Médico Principal</label>
                        <input type="text" id="editDoctor" name="doctor">
                    </div>
                    <div class="form-group">
                        <label for="editClinic">Centro Médico</label>
                        <input type="text" id="editClinic" name="clinic">
                    </div>
                    <div class="form-group">
                        <label for="editAllergies">Alergias</label>
                        <textarea id="editAllergies" name="allergies" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editConditions">Condiciones Médicas</label>
                        <textarea id="editConditions" name="conditions" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelEditBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveProfileBtn">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            if (typeof Meditrack === 'undefined') {
                console.error('MediTrack API no está disponible');
                setTimeout(function() {
                    window.location.href = '../auth/login.html';
                }, 1000);
                return;
            }
            
            const currentUser = Meditrack.getCurrentUser();
            if (!currentUser) {
                console.error('Usuario no autenticado, redirigiendo a login');
                window.location.href = '../auth/login.html';
                return;
            }
            
            // Configurar botón de logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                Meditrack.logout();
            });
            
            // Configurar acciones del menú móvil
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    document.body.classList.toggle('no-scroll');
                });
            }
            
            // Cargar datos del perfil
            loadProfileData();
            
            // Configurar eventos para edición
            document.getElementById('editProfileBtn').addEventListener('click', openEditModal);
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfileChanges);
            
            // Función para cargar datos del perfil
            function loadProfileData() {
                const profile = currentUser;
                
                // Intentar cargar el avatar con fallback
                const avatar = document.getElementById('profileAvatar');
                avatar.onerror = function() {
                    // Intentar usar la imagen generada por data URL
                    const fallbackImage = localStorage.getItem('image_default-avatar');
                    if (fallbackImage) {
                        this.src = fallbackImage;
                    }
                };
                
                // Actualizar datos básicos
                document.getElementById('profileName').textContent = profile.name || 'Usuario';
                document.getElementById('profileRole').textContent = 'Paciente';
                document.getElementById('profileEmail').textContent = profile.email || 'No especificado';
                document.getElementById('profilePhone').textContent = profile.phone || 'No especificado';
                document.getElementById('profileBirthday').textContent = profile.birthday || 'No especificado';
                document.getElementById('profileGender').textContent = getGenderText(profile.gender);
                
                // Información médica
                document.getElementById('profileDoctor').textContent = profile.doctor || 'No especificado';
                document.getElementById('profileClinic').textContent = profile.clinic || 'No especificado';
                document.getElementById('profileAllergies').textContent = profile.allergies || 'Ninguna registrada';
                document.getElementById('profileConditions').textContent = profile.conditions || 'Ninguna registrada';
                
                // Actualizar contactos de emergencia
                updateEmergencyContacts(profile.emergencyContacts || []);
                
                // Inicializar preferencias
                if (profile.notificationSettings) {
                    document.getElementById('notificationToggle').checked = profile.notificationSettings.enabled || false;
                }
            }
            
            function getGenderText(gender) {
                switch(gender) {
                    case 'male': return 'Masculino';
                    case 'female': return 'Femenino';
                    case 'other': return 'Otro';
                    default: return 'No especificado';
                }
            }
            
            function updateEmergencyContacts(contacts) {
                const contactsContainer = document.getElementById('emergencyContacts');
                
                // Mantener solo el botón de añadir
                const addButton = contactsContainer.querySelector('#addEmergencyContact');
                contactsContainer.innerHTML = '';
                
                if (contacts && contacts.length > 0) {
                    contacts.forEach((contact, index) => {
                        const contactCard = document.createElement('div');
                        contactCard.className = 'contact-card';
                        contactCard.innerHTML = `
                            <div class="contact-info">
                                <div class="contact-name">${contact.name}</div>
                                <div class="contact-relation">${contact.relation}</div>
                            </div>
                            <div class="contact-details">
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i> ${contact.phone}
                                </div>
                                ${contact.email ? `
                                <div class="contact-item">
                                    <i class="fas fa-envelope"></i> ${contact.email}
                                </div>` : ''}
                            </div>
                            <button class="contact-delete" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        contactsContainer.appendChild(contactCard);
                    });
                } else {
                    const emptyMessage = document.createElement('p');
                    emptyMessage.textContent = 'No hay contactos de emergencia registrados.';
                    contactsContainer.appendChild(emptyMessage);
                }
                
                contactsContainer.appendChild(addButton);
            }
            
            function openEditModal() {
                const profile = Meditrack.getCurrentUser();
                
                // Llenar formulario con datos actuales
                document.getElementById('editName').value = profile.name || '';
                document.getElementById('editEmail').value = profile.email || '';
                document.getElementById('editPhone').value = profile.phone || '';
                document.getElementById('editBirthday').value = profile.birthday || '';
                document.getElementById('editGender').value = profile.gender || '';
                document.getElementById('editDoctor').value = profile.doctor || '';
                document.getElementById('editClinic').value = profile.clinic || '';
                document.getElementById('editAllergies').value = profile.allergies || '';
                document.getElementById('editConditions').value = profile.conditions || '';
                
                // Mostrar modal
                document.getElementById('editProfileModal').style.display = 'block';
            }
            
            function closeEditModal() {
                document.getElementById('editProfileModal').style.display = 'none';
            }
            
            function saveProfileChanges() {
                // Obtener valores del formulario
                const updatedProfile = {
                    name: document.getElementById('editName').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    birthday: document.getElementById('editBirthday').value,
                    gender: document.getElementById('editGender').value,
                    doctor: document.getElementById('editDoctor').value,
                    clinic: document.getElementById('editClinic').value,
                    allergies: document.getElementById('editAllergies').value,
                    conditions: document.getElementById('editConditions').value
                };
                
                // Actualizar perfil en localStorage
                Meditrack.updateUserProfile(updatedProfile);
                
                // Actualizar UI
                loadProfileData();
                
                // Cerrar modal
                closeEditModal();
                
                // Mostrar mensaje de éxito
                alert('Perfil actualizado correctamente.');
            }

            document.getElementById('notificationToggle').addEventListener('change', function(e) {
                const currentUser = Meditrack.getCurrentUser();
                if (!currentUser) return;
                
                const enabled = e.target.checked;
                
                if (enabled) {
                    // Si quiere activar notificaciones, solicitar permiso si es necesario
                    Meditrack.requestNotificationPermission()
                        .then(granted => {
                            // Actualizar el toggle según el resultado real
                            document.getElementById('notificationToggle').checked = granted;
                            
                            if (!granted) {
                                alert('No se pudo habilitar las notificaciones. Por favor, revisa la configuración de tu navegador.');
                            }
                        });
                } else {
                    // Actualizar preferencias para deshabilitar notificaciones
                    const updatedSettings = {
                        notificationSettings: {
                            ...currentUser.notificationSettings,
                            enabled: false
                        }
                    };
                    Meditrack.updateUserProfile(updatedSettings);
                }
            });
        });
    </script>

    <style>
        /* Estilos específicos para la página de perfil */
        .profile-info-item {
            display: flex;
            margin-bottom: 1.2em;
            border-bottom: 1px solid var(--grey);
            padding-bottom: 1.2em;
        }
        
        .profile-info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .profile-info-label {
            width: 40%;
            font-weight: 600;
            color: var(--dark-grey);
            display: flex;
            align-items: center;
        }
        
        .profile-info-label i {
            margin-right: 10px;
            color: var(--primary);
            width: 20px;
            text-align: center;
        }
        
        .profile-info-value {
            width: 60%;
            color: var(--black);
        }
        
        .contact-card {
            background-color: var(--light-grey);
            padding: 1em;
            border-radius: var(--border-radius);
            margin-bottom: 1em;
            position: relative;
        }
        
        .contact-name {
            font-weight: 600;
            margin-bottom: 0.2em;
        }
        
        .contact-relation {
            font-size: var(--font-size-small);
            color: var(--dark-grey);
            margin-bottom: 0.5em;
        }
        
        .contact-details {
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }
        
        .contact-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--dark-grey);
            cursor: pointer;
            font-size: var(--font-size-small);
        }
        
        .contact-delete:hover {
            color: var(--warning);
        }
        
        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2em;
            padding-bottom: 1em;
            border-bottom: 1px solid var(--grey);
        }
        
        .preference-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--grey);
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .profile-info-item {
                flex-direction: column;
            }
            
            .profile-info-label, .profile-info-value {
                width: 100%;
            }
            
            .profile-info-value {
                margin-top: 0.5em;
            }
        }
    </style>
</body>
</html> 